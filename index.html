<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Budallas Card Game</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; text-align: center; }
        .game-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { 
            display: inline-block; 
            background: white; 
            color: black; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
            border: 2px solid #ccc;
        }
        .card.selected { border-color: gold; background: #fffbe6; transform: translateY(-5px); }
        .red { color: red; }
        .black { color: black; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #game-board { display: none; }
        .table-area { background: #34495e; min-height: 150px; border-radius: 10px; margin: 20px 0; padding: 10px; }
        .info-panel { display: flex; justify-content: space-between; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="game-container">
    <h1>Budallas</h1>
    
    <div id="login-screen">
        <input type="text" id="username" placeholder="Enter Name" />
        <input type="text" id="room" placeholder="Room ID (e.g. room1)" />
        <button onclick="joinGame()">Join Game</button>
    </div>

    <div id="lobby-screen" style="display:none;">
        <h2>Waiting Room: <span id="lobby-room-name"></span></h2>
        <p>Players: <span id="player-list"></span></p>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="game-board">
        <div class="info-panel">
            <span>Trump: <span id="trump-display"></span></span>
            <span>Deck: <span id="deck-count"></span></span>
            <span>Turn: <span id="current-turn"></span></span>
        </div>

        <div class="table-area">
            <h3>Table (Attack / Defend)</h3>
            <div id="table-cards"></div>
        </div>

        <div class="controls">
            <button onclick="performAction('attack')">Attack</button>
            <button onclick="performAction('defend')">Defend</button>
            <button onclick="performAction('pass')">Pass</button>
            <button onclick="performAction('take')">Take</button>
            <button onclick="performAction('skip')">Skip / Done</button>
        </div>

        <h3>Your Hand</h3>
        <div id="my-hand"></div>
        <p id="status-msg" style="color: yellow;"></p>
    </div>
</div>

<script>
    // 1. CONNECT TO YOUR RENDER BACKEND
    const socket = io("https://budallas-backend.onrender.com", {
        transports: ["websocket"], 
        cors: { origin: "*" }
    });

    let myName = "";
    let selectedCards = [];

    // --- Socket Listeners ---

    socket.on('connect', () => {
        console.log("Connected to server!");
    });

    socket.on('lobby_update', (data) => {
        document.getElementById('player-list').innerText = data.players.join(", ");
    });

    socket.on('game_update', (state) => {
        renderGame(state);
    });

    socket.on('error', (data) => {
        alert("Error: " + data.message);
    });

    socket.on('game_over', (data) => {
        alert(data.message);
    });

    // --- User Actions ---

    function joinGame() {
        myName = document.getElementById('username').value;
        const room = document.getElementById('room').value;
        if (!myName || !room) return alert("Enter name and room!");

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('lobby-room-name').innerText = room;

        socket.emit('join_game', { room: room, name: myName });
    }

    function startGame() {
        socket.emit('start_game', {});
    }

    function toggleCard(rank, suit, element) {
        // Simple selection logic
        const index = selectedCards.findIndex(c => c.rank === rank && c.suit === suit);
        if (index > -1) {
            selectedCards.splice(index, 1);
            element.classList.remove('selected');
        } else {
            selectedCards.push({ rank, suit });
            element.classList.add('selected');
        }
    }

    function performAction(action) {
        if (action === 'skip') {
            socket.emit('skip', {});
            selectedCards = [];
            return;
        }

        if (action === 'take') {
            socket.emit('take', {});
            selectedCards = [];
            return;
        }

        if (selectedCards.length === 0) return alert("Select cards first!");

        if (action === 'attack') {
            socket.emit('attack', selectedCards[0]); // Send single card
        } 
        else if (action === 'pass') {
            socket.emit('pass', selectedCards[0]);
        }
        else if (action === 'defend') {
            if (selectedCards.length !== 2) return alert("Select exactly 2 cards (Attack card first, then your Defense card).");
            // NOTE: Logic assumes user clicks Attack card on table first, then their Hand card.
            // For simplicity in this demo, we might need a clearer UI for "which card beats which".
            // A simple hack: The first card clicked is the ATTACK card (from table), second is DEFENSE (from hand).
            socket.emit('defend', {
                attack_rank: selectedCards[0].rank,
                attack_suit: selectedCards[0].suit,
                defend_rank: selectedCards[1].rank,
                defend_suit: selectedCards[1].suit
            });
        }

        // Reset selection
        selectedCards = []; 
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    }

    // --- Rendering ---

    function renderGame(state) {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-board').style.display = 'block';

        // Stats
        const trump = state.trump_card ? `${state.trump_card.display}` : state.trump_suit;
        document.getElementById('trump-display').innerText = trump;
        document.getElementById('deck-count').innerText = state.deck_count;
        document.getElementById('current-turn').innerText = `Attacker: ${state.attacker_name} | Defender: ${state.defender_name}`;
        
        if(state.active_attacker_name) {
             document.getElementById('status-msg').innerText = `Current Action: ${state.active_attacker_name}'s turn`;
        }

        // Table
        const tableDiv = document.getElementById('table-cards');
        tableDiv.innerHTML = "";
        
        // Combine attack and defense for display
        // Note: A better UI would separate them visually (e.g. overlapping pairs)
        [...state.table_attack, ...state.table_defense].forEach(c => {
            tableDiv.appendChild(createCardElem(c, true));
        });

        // Hand
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        const me = state.players.find(p => p.is_me);
        if (me && me.hand) {
            me.hand.forEach(c => {
                handDiv.appendChild(createCardElem(c, false));
            });
        }
    }

    function createCardElem(card, isTable) {
        const div = document.createElement('div');
        div.className = `card ${['♥','♦'].includes(card.suit) ? 'red' : 'black'}`;
        div.innerText = card.display;
        div.onclick = () => toggleCard(card.rank, card.suit, div);
        return div;
    }
</script>

</body>
</html>